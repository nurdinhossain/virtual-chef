<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web AR with Three.js and Motion Tracking</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
<button id="ar-button">Start AR</button>
<button id="move-button" style="position: absolute; bottom: 20px; left: 20px;">Move Model</button>
<script>
    let camera, scene, renderer, loader;
    let model;
    let targetPosition = new THREE.Vector3(0, 0, -1);

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        loader = new THREE.GLTFLoader();
        loader.load('NONRIGGED.glb', function (gltf) {
            model = gltf.scene;
            model.position.set(0, 0, -1); // Position the model in front of the camera
            scene.add(model);
        });

        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
        scene.add(light);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        renderer.setAnimationLoop(render);
    }

    function moveModelToPosition(targetPosition, speed = 0.1) {
        if (model) {
            const direction = new THREE.Vector3().subVectors(targetPosition, model.position);
            const distance = direction.length();
            if (distance > 0.01) {
                direction.normalize().multiplyScalar(speed);
                model.position.add(direction);
            }
        }
    }

    function updateTargetPosition(x, y, z) {
        targetPosition.set(x, y, z);
    }

    function render(timestamp, frame) {
        if (frame) {
            const pose = frame.getViewerPose(referenceSpace);
            if (pose) {
                const view = pose.views[0];
                const viewMatrix = new THREE.Matrix4().fromArray(view.transform.inverse.matrix);

                // Update the camera
                camera.matrix.fromArray(viewMatrix.elements);
                camera.matrix.decompose(camera.position, camera.quaternion, camera.scale);

                // Move the model towards the target position
                moveModelToPosition(targetPosition);

                // Update the model's position relative to the camera
                if (model) {
                    model.position.applyMatrix4(camera.matrixWorld);
                }
            }
        }
        renderer.render(scene, camera);
    }

    init();
    animate();
    window.addEventListener('resize', onWindowResize, false);

    let currentSession = null;
    let referenceSpace = null;

    document.getElementById('ar-button').addEventListener('click', function () {
        if (currentSession === null) {
            navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['local']
            }).then(onSessionStarted);
        } else {
            currentSession.end();
        }
    });

    document.getElementById('move-button').addEventListener('click', function () {
        // Move the model 0.5 units to the right and 0.5 units up
        updateTargetPosition(0.5, 0.5, -1);
    });

    function onSessionStarted(session) {
        currentSession = session;
        renderer.xr.setReferenceSpaceType('local');
        renderer.xr.setSession(session);

        session.requestReferenceSpace('local').then((space) => {
            referenceSpace = space;
            animate();
        });

        session.addEventListener('end', onSessionEnded);
    }

    function onSessionEnded() {
        currentSession = null;
    }
</script>
</body>
</html>